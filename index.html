<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>YKS Net Takip</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    * {
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to bottom right, #f8fafc, #eff6ff);
      min-height: 100vh;
      overscroll-behavior: none;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 1rem;
      max-width: 95%;
      max-height: 95vh;
      overflow-y: auto;
      padding: 1.5rem;
      margin: 1rem;
    }

    .tab-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      transition: all 0.2s;
      cursor: pointer;
      border: 2px solid transparent;
    }

    .tab-btn.active {
      background: linear-gradient(to right, #3b82f6, #2563eb);
      color: white;
    }

    .tab-btn:not(.active) {
      background: white;
      color: #64748b;
      border-color: #e2e8f0;
    }

    input,
    textarea,
    select {
      font-size: 16px !important;
      /* Prevents zoom on iOS */
    }

    .touch-btn {
      min-height: 44px;
      min-width: 44px;
    }
  </style>
</head>

<body>
  <div id="app" class="min-h-screen pb-20">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 sticky top-0 z-50 shadow-lg">
      <h1 class="text-2xl font-bold text-center">ğŸ“š YKS Net Takip</h1>
      <div id="syncStatus" class="text-center text-xs mt-1 opacity-90">YÃ¼kleniyor...</div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-6">
      <!-- Countdown Section -->
      <div class="mb-6">
        <div
          class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl p-5 text-white shadow-lg relative overflow-hidden">
          <!-- Decorative Background Elements -->
          <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
          <div class="absolute bottom-0 left-0 -mb-4 -ml-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>

          <div class="relative z-10">
            <h2 class="text-center text-sm font-semibold mb-4 opacity-90 tracking-wide uppercase">ğŸ“ YKS 2027'ye Kalan
              SÃ¼re</h2>
            <div class="flex justify-center gap-3 text-center">
              <div class="bg-white/20 rounded-lg p-2 min-w-[70px] backdrop-blur-sm border border-white/10">
                <div class="text-2xl font-bold font-mono" id="cd-days">--</div>
                <div class="text-[10px] uppercase tracking-wider opacity-80 mt-1">GÃ¼n</div>
              </div>
              <div class="bg-white/20 rounded-lg p-2 min-w-[60px] backdrop-blur-sm border border-white/10">
                <div class="text-2xl font-bold font-mono" id="cd-hours">--</div>
                <div class="text-[10px] uppercase tracking-wider opacity-80 mt-1">Saat</div>
              </div>
              <div class="bg-white/20 rounded-lg p-2 min-w-[60px] backdrop-blur-sm border border-white/10">
                <div class="text-2xl font-bold font-mono" id="cd-minutes">--</div>
                <div class="text-[10px] uppercase tracking-wider opacity-80 mt-1">Dk</div>
              </div>
              <div class="bg-white/20 rounded-lg p-2 min-w-[60px] backdrop-blur-sm border border-white/10">
                <div class="text-2xl font-bold font-mono" id="cd-seconds">--</div>
                <div class="text-[10px] uppercase tracking-wider opacity-80 mt-1">Sn</div>
              </div>
            </div>
            <div class="text-center mt-3 text-xs opacity-75" id="target-date-text"></div>
          </div>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
        <button class="tab-btn active touch-btn" onclick="switchTab('exams')">ğŸ¯ Denemeler</button>
        <button class="tab-btn touch-btn" onclick="switchTab('tests')">ğŸ“ Testler</button>
        <button class="tab-btn touch-btn" onclick="switchTab('stats')">ğŸ“Š Ä°statistikler</button>
      </div>

      <!-- Exams Tab -->
      <div id="examsTab" class="tab-content">
        <!-- Stats Cards -->
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="bg-white p-4 rounded-xl shadow-lg">
            <p class="text-xs text-green-600 mb-1">En YÃ¼ksek</p>
            <p class="text-2xl font-bold text-green-700" id="highestNet">0.00</p>
          </div>
          <div class="bg-white p-4 rounded-xl shadow-lg">
            <p class="text-xs text-blue-600 mb-1">Ortalama</p>
            <p class="text-2xl font-bold text-blue-700" id="averageNet">0.00</p>
          </div>
        </div>

        <!-- Add Exam Button -->
        <button onclick="openExamModal()"
          class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 rounded-xl font-semibold shadow-lg mb-6 touch-btn">
          â• Yeni Deneme Ekle
        </button>

        <!-- Search & Filter -->
        <div class="bg-white p-4 rounded-xl shadow-lg mb-6">
          <input type="text" id="examSearch" placeholder="ğŸ” Deneme ara..."
            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
        </div>

        <!-- Exams List -->
        <div id="examsList"></div>
        <div id="examsEmpty" class="text-center py-12 text-slate-500 hidden">
          <p class="text-xl mb-2">ğŸ“ HenÃ¼z deneme yok</p>
          <p class="text-sm">YukarÄ±daki butona tÄ±klayarak ilk denemenizi ekleyin!</p>
        </div>
      </div>

      <!-- Tests Tab -->
      <div id="testsTab" class="tab-content hidden">
        <button onclick="openTestModal()"
          class="w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white p-4 rounded-xl font-semibold shadow-lg mb-6 touch-btn">
          â• Yeni Test Ekle
        </button>

        <div class="bg-white p-4 rounded-xl shadow-lg mb-6">
          <input type="text" id="testSearch" placeholder="ğŸ” Test ara..."
            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
        </div>

        <div id="testsList"></div>
        <div id="testsEmpty" class="text-center py-12 text-slate-500 hidden">
          <p class="text-xl mb-2">ğŸ“š HenÃ¼z test yok</p>
          <p class="text-sm">Ã‡Ã¶zdÃ¼ÄŸÃ¼nÃ¼z testleri buradan takip edebilirsiniz!</p>
        </div>
      </div>

      <!-- Stats Tab -->
      <div id="statsTab" class="tab-content hidden">
        <div class="space-y-6">
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-bold mb-4">ğŸ“ˆ Net GeliÅŸim GrafiÄŸi</h3>
            <canvas id="netChart"></canvas>
          </div>

          <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-lg font-bold mb-4">ğŸ“Š DoÄŸru/YanlÄ±ÅŸ DaÄŸÄ±lÄ±mÄ±</h3>
            <canvas id="correctWrongChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Exam Modal -->
  <div id="examModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold" id="examModalTitle">Yeni Deneme</h2>
        <button onclick="closeExamModal()" class="text-2xl text-slate-500">&times;</button>
      </div>

      <form id="examForm" class="space-y-4">
        <input type="hidden" id="examId">

        <div>
          <label class="block text-sm font-semibold mb-2">Tarih</label>
          <input type="date" id="examDate" required
            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Deneme AdÄ±</label>
          <input type="text" id="examName" placeholder="Ã–rn: TYT Deneme 1 - Acil" required
            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Notlar (Ä°steÄŸe baÄŸlÄ±)</label>
          <textarea id="examNotes" rows="2" placeholder="Deneme hakkÄ±nda notlarÄ±nÄ±z..."
            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
        </div>

        <!-- Subjects -->
        <div class="space-y-4">
          <!-- TÃ¼rkÃ§e -->
          <div class="p-3 bg-red-50 border-2 border-red-200 rounded-lg">
            <h3 class="font-semibold mb-2 text-sm">TÃ¼rkÃ§e (40)</h3>
            <div class="grid grid-cols-3 gap-2">
              <input type="number" min="0" max="40" value="0" id="turkceD" placeholder="D"
                class="px-3 py-2 border rounded text-center">
              <input type="number" min="0" max="40" value="0" id="turkceY" placeholder="Y"
                class="px-3 py-2 border rounded text-center">
              <div id="turkceNet" class="px-3 py-2 bg-slate-100 rounded text-center font-bold text-blue-700">0.00</div>
            </div>
          </div>

          <!-- Sosyal -->
          <div class="p-3 bg-yellow-50 border-2 border-yellow-200 rounded-lg">
            <h3 class="font-semibold mb-2 text-sm">Sosyal (20)</h3>
            <div class="space-y-1 mb-2 text-xs">
              <div class="grid grid-cols-3 gap-1">
                <span>Tarih</span>
                <input type="number" min="0" max="5" value="0" id="tarihD" class="px-2 py-1 border rounded text-center">
                <input type="number" min="0" max="5" value="0" id="tarihY" class="px-2 py-1 border rounded text-center">
              </div>
              <div class="grid grid-cols-3 gap-1">
                <span>CoÄŸrafya</span>
                <input type="number" min="0" max="5" value="0" id="cografyaD"
                  class="px-2 py-1 border rounded text-center">
                <input type="number" min="0" max="5" value="0" id="cografyaY"
                  class="px-2 py-1 border rounded text-center">
              </div>
              <div class="grid grid-cols-3 gap-1">
                <span>Felsefe</span>
                <input type="number" min="0" max="5" value="0" id="felsefeD"
                  class="px-2 py-1 border rounded text-center">
                <input type="number" min="0" max="5" value="0" id="felsefeY"
                  class="px-2 py-1 border rounded text-center">
              </div>
              <div class="grid grid-cols-3 gap-1">
                <span>Din</span>
                <input type="number" min="0" max="5" value="0" id="dinD" class="px-2 py-1 border rounded text-center">
                <input type="number" min="0" max="5" value="0" id="dinY" class="px-2 py-1 border rounded text-center">
              </div>
            </div>
            <div class="grid grid-cols-3 gap-2 pt-2 border-t">
              <span class="text-xs font-semibold">Toplam</span>
              <div id="sosyalD" class="text-center font-bold text-yellow-700">0</div>
              <div id="sosyalY" class="text-center font-bold text-yellow-700">0</div>
            </div>
            <div id="sosyalNet" class="mt-2 px-3 py-2 bg-slate-100 rounded text-center font-bold text-blue-700">0.00
            </div>
          </div>

          <!-- Matematik -->
          <div class="p-3 bg-blue-50 border-2 border-blue-200 rounded-lg">
            <h3 class="font-semibold mb-2 text-sm">Matematik (40)</h3>
            <div class="grid grid-cols-3 gap-2">
              <input type="number" min="0" max="40" value="0" id="matematikD" placeholder="D"
                class="px-3 py-2 border rounded text-center">
              <input type="number" min="0" max="40" value="0" id="matematikY" placeholder="Y"
                class="px-3 py-2 border rounded text-center">
              <div id="matematikNet" class="px-3 py-2 bg-slate-100 rounded text-center font-bold text-blue-700">0.00
              </div>
            </div>
          </div>

          <!-- Fen -->
          <div class="p-3 bg-green-50 border-2 border-green-200 rounded-lg">
            <h3 class="font-semibold mb-2 text-sm">Fen (20)</h3>
            <div class="space-y-1 mb-2 text-xs">
              <div class="grid grid-cols-3 gap-1">
                <span>Fizik</span>
                <input type="number" min="0" max="7" value="0" id="fizikD" class="px-2 py-1 border rounded text-center">
                <input type="number" min="0" max="7" value="0" id="fizikY" class="px-2 py-1 border rounded text-center">
              </div>
              <div class="grid grid-cols-3 gap-1">
                <span>Kimya</span>
                <input type="number" min="0" max="7" value="0" id="kimyaD" class="px-2 py-1 border rounded text-center">
                <input type="number" min="0" max="7" value="0" id="kimyaY" class="px-2 py-1 border rounded text-center">
              </div>
              <div class="grid grid-cols-3 gap-1">
                <span>Biyoloji</span>
                <input type="number" min="0" max="6" value="0" id="biyolojiD"
                  class="px-2 py-1 border rounded text-center">
                <input type="number" min="0" max="6" value="0" id="biyolojiY"
                  class="px-2 py-1 border rounded text-center">
              </div>
            </div>
            <div class="grid grid-cols-3 gap-2 pt-2 border-t">
              <span class="text-xs font-semibold">Toplam</span>
              <div id="fenD" class="text-center font-bold text-green-700">0</div>
              <div id="fenY" class="text-center font-bold text-green-700">0</div>
            </div>
            <div id="fenNet" class="mt-2 px-3 py-2 bg-slate-100 rounded text-center font-bold text-blue-700">0.00</div>
          </div>
        </div>

        <button type="submit" id="examSubmitBtn"
          class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition touch-btn">
          Kaydet
        </button>
      </form>
    </div>
  </div>

  <!-- Test Modal -->
  <div id="testModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold" id="testModalTitle">Yeni Test</h2>
        <button onclick="closeTestModal()" class="text-2xl text-slate-500">&times;</button>
      </div>

      <form id="testForm" class="space-y-4">
        <input type="hidden" id="testId">

        <div>
          <label class="block text-sm font-semibold mb-2">Tarih</label>
          <input type="date" id="testDate" required
            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Ders</label>
          <select id="testSubject" required
            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
            <option value="turkce">TÃ¼rkÃ§e</option>
            <option value="tarih">Tarih</option>
            <option value="cografya">CoÄŸrafya</option>
            <option value="felsefe">Felsefe</option>
            <option value="din">Din</option>
            <option value="matematik">Matematik</option>
            <option value="fizik">Fizik</option>
            <option value="kimya">Kimya</option>
            <option value="biyoloji">Biyoloji</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Konu/Test AdÄ±</label>
          <input type="text" id="testName" placeholder="Ã–rn: Paragraf Testi" required
            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-2">DoÄŸru</label>
            <input type="number" min="0" value="0" id="testCorrect"
              class="w-full px-4 py-3 border rounded-lg text-center focus:ring-2 focus:ring-purple-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">YanlÄ±ÅŸ</label>
            <input type="number" min="0" value="0" id="testWrong"
              class="w-full px-4 py-3 border rounded-lg text-center focus:ring-2 focus:ring-purple-500 outline-none">
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold mb-2">Notlar</label>
          <textarea id="testNotes" rows="2" placeholder="Test hakkÄ±nda notlar..."
            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"></textarea>
        </div>

        <button type="submit" id="testSubmitBtn"
          class="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition touch-btn">
          Kaydet
        </button>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBYf7oM8s1cdWo360BH9cQC6DcnCFbCN0o",
      authDomain: "nalan-yks.firebaseapp.com",
      projectId: "nalan-yks",
      storageBucket: "nalan-yks.firebasestorage.app",
      messagingSenderId: "388062350597",
      appId: "1:388062350597:web:6a02458e1fa07f99077b6c",
      measurementId: "G-8YY79ZT7NL"
    };

    let app, db, analytics, useFirebase = true;
    try {
      app = initializeApp(firebaseConfig);
      analytics = getAnalytics(app);
      db = getFirestore(app);
    } catch (error) {
      console.error("Firebase error:", error);
      useFirebase = false;
    }

    let exams = [];
    let tests = [];
    let currentEditingExam = null;
    let currentEditingTest = null;

    const syncStatus = document.getElementById('syncStatus');

    // Net calculation
    function calculateNet(dogru, yanlis) {
      return Math.max(0, dogru - (yanlis / 4)).toFixed(2);
    }

    // Update subject totals
    function updateSubjectTotals() {
      const sosyalD = ['tarih', 'cografya', 'felsefe', 'din'].reduce((sum, sub) =>
        sum + (parseInt(document.getElementById(sub + 'D').value) || 0), 0);
      const sosyalY = ['tarih', 'cografya', 'felsefe', 'din'].reduce((sum, sub) =>
        sum + (parseInt(document.getElementById(sub + 'Y').value) || 0), 0);

      document.getElementById('sosyalD').textContent = sosyalD;
      document.getElementById('sosyalY').textContent = sosyalY;
      document.getElementById('sosyalNet').textContent = calculateNet(sosyalD, sosyalY);

      const fenD = ['fizik', 'kimya', 'biyoloji'].reduce((sum, sub) =>
        sum + (parseInt(document.getElementById(sub + 'D').value) || 0), 0);
      const fenY = ['fizik', 'kimya', 'biyoloji'].reduce((sum, sub) =>
        sum + (parseInt(document.getElementById(sub + 'Y').value) || 0), 0);

      document.getElementById('fenD').textContent = fenD;
      document.getElementById('fenY').textContent = fenY;
      document.getElementById('fenNet').textContent = calculateNet(fenD, fenY);
    }

    function updateNets() {
      ['turkce', 'matematik'].forEach(subject => {
        const dogru = parseInt(document.getElementById(subject + 'D').value) || 0;
        const yanlis = parseInt(document.getElementById(subject + 'Y').value) || 0;
        document.getElementById(subject + 'Net').textContent = calculateNet(dogru, yanlis);
      });
      updateSubjectTotals();
    }

    document.querySelectorAll('input[type="number"]').forEach(input => {
      input.addEventListener('input', updateNets);
    });

    // Tab switching
    window.switchTab = function (tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

      event.target.classList.add('active');
      document.getElementById(tab + 'Tab').classList.remove('hidden');

      if (tab === 'stats') {
        setTimeout(() => createCharts(), 100);
      }
    };

    // Update stats
    function updateStats() {
      if (exams.length === 0) {
        document.getElementById('highestNet').textContent = '0.00';
        document.getElementById('averageNet').textContent = '0.00';
        return;
      }

      const totalNets = exams.map(e => parseFloat(e.totalNet));
      const highest = Math.max(...totalNets);
      const average = (totalNets.reduce((a, b) => a + b, 0) / totalNets.length).toFixed(2);

      document.getElementById('highestNet').textContent = highest.toFixed(2);
      document.getElementById('averageNet').textContent = average;
    }

    // Render exams
    function renderExams(filter = '') {
      const listEl = document.getElementById('examsList');
      const emptyEl = document.getElementById('examsEmpty');

      const filtered = exams.filter(e =>
        e.name.toLowerCase().includes(filter.toLowerCase()) ||
        new Date(e.date).toLocaleDateString('tr-TR').includes(filter)
      );

      if (filtered.length === 0) {
        listEl.innerHTML = '';
        emptyEl.classList.remove('hidden');
        return;
      }

      emptyEl.classList.add('hidden');
      listEl.innerHTML = filtered.map(exam => `
        <div class="bg-white p-4 rounded-xl shadow-lg mb-4">
          <div class="flex justify-between items-start mb-3">
            <div>
              <h3 class="font-bold text-lg">${exam.name}</h3>
              <p class="text-sm text-slate-600">${new Date(exam.date).toLocaleDateString('tr-TR')}</p>
              ${exam.notes ? `<p class="text-xs text-slate-500 mt-1">${exam.notes}</p>` : ''}
            </div>
            <div class="flex gap-2">
              <button onclick="editExam('${exam.firebaseId || exam.id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm touch-btn">âœï¸</button>
              <button onclick="deleteExam('${exam.firebaseId || exam.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm touch-btn">ğŸ—‘ï¸</button>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div><span class="font-semibold text-red-600">TÃ¼rkÃ§e:</span> ${exam.nets.turkce}</div>
            <div><span class="font-semibold text-yellow-600">Sosyal:</span> ${exam.nets.sosyal}</div>
            <div><span class="font-semibold text-blue-600">Matematik:</span> ${exam.nets.matematik}</div>
            <div><span class="font-semibold text-green-600">Fen:</span> ${exam.nets.fen}</div>
          </div>
          <div class="mt-2 pt-2 border-t">
            <span class="font-bold text-purple-600">Toplam Net: ${exam.totalNet}</span>
          </div>
        </div>
      `).join('');
    }

    // Render tests
    function renderTests(filter = '') {
      const listEl = document.getElementById('testsList');
      const emptyEl = document.getElementById('testsEmpty');

      const filtered = tests.filter(t =>
        t.name.toLowerCase().includes(filter.toLowerCase()) ||
        t.subject.toLowerCase().includes(filter.toLowerCase())
      );

      if (filtered.length === 0) {
        listEl.innerHTML = '';
        emptyEl.classList.remove('hidden');
        return;
      }

      emptyEl.classList.add('hidden');

      const subjectColors = {
        turkce: 'red', tarih: 'yellow', cografya: 'yellow', felsefe: 'yellow', din: 'yellow',
        matematik: 'blue', fizik: 'green', kimya: 'green', biyoloji: 'green'
      };

      listEl.innerHTML = filtered.map(test => {
        const color = subjectColors[test.subject] || 'gray';
        const net = calculateNet(test.correct, test.wrong);
        return `
          <div class="bg-white p-4 rounded-xl shadow-lg mb-4">
            <div class="flex justify-between items-start mb-2">
              <div>
                <span class="text-xs font-semibold text-${color}-600 bg-${color}-100 px-2 py-1 rounded">${test.subject.toUpperCase()}</span>
                <h3 class="font-bold mt-1">${test.name}</h3>
                <p class="text-sm text-slate-600">${new Date(test.date).toLocaleDateString('tr-TR')}</p>
                ${test.notes ? `<p class="text-xs text-slate-500 mt-1">${test.notes}</p>` : ''}
              </div>
              <div class="flex gap-2">
                <button onclick="editTest('${test.firebaseId || test.id}')" class="bg-purple-500 text-white px-3 py-1 rounded text-sm touch-btn">âœï¸</button>
                <button onclick="deleteTest('${test.firebaseId || test.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm touch-btn">ğŸ—‘ï¸</button>
              </div>
            </div>
            <div class="flex gap-4 text-sm">
              <span class="text-green-600">âœ“ ${test.correct}</span>
              <span class="text-red-600">âœ— ${test.wrong}</span>
              <span class="font-bold text-blue-600">Net: ${net}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // Search handlers
    document.getElementById('examSearch').addEventListener('input', (e) => {
      renderExams(e.target.value);
    });

    document.getElementById('testSearch').addEventListener('input', (e) => {
      renderTests(e.target.value);
    });

    // Load data
    async function loadExams() {
      if (!useFirebase) {
        syncStatus.innerHTML = 'âš ï¸ Ã‡evrimdÄ±ÅŸÄ±';
        exams = JSON.parse(localStorage.getItem('yks-exams') || '[]');
        tests = JSON.parse(localStorage.getItem('yks-tests') || '[]');
        renderExams();
        renderTests();
        updateStats();
        return;
      }

      try {
        syncStatus.innerHTML = '<div class="loading"></div> YÃ¼kleniyor...';

        const [examsSnap, testsSnap] = await Promise.all([
          getDocs(query(collection(db, 'exams'), orderBy('date', 'desc'))),
          getDocs(query(collection(db, 'tests'), orderBy('date', 'desc')))
        ]);

        exams = [];
        examsSnap.forEach(doc => exams.push({ ...doc.data(), firebaseId: doc.id }));

        tests = [];
        testsSnap.forEach(doc => tests.push({ ...doc.data(), firebaseId: doc.id }));

        localStorage.setItem('yks-exams', JSON.stringify(exams));
        localStorage.setItem('yks-tests', JSON.stringify(tests));

        syncStatus.innerHTML = 'â˜ï¸ Senkronize';
        renderExams();
        renderTests();
        updateStats();
      } catch (error) {
        console.error("Load error:", error);
        syncStatus.innerHTML = 'âš ï¸ Hata';
        exams = JSON.parse(localStorage.getItem('yks-exams') || '[]');
        tests = JSON.parse(localStorage.getItem('yks-tests') || '[]');
        renderExams();
        renderTests();
        updateStats();
      }
    }

    // Exam modal functions
    window.openExamModal = function () {
      currentEditingExam = null;
      document.getElementById('examModalTitle').textContent = 'Yeni Deneme';
      document.getElementById('examForm').reset();
      document.getElementById('examDate').valueAsDate = new Date();
      document.getElementById('examId').value = '';
      updateNets();
      document.getElementById('examModal').classList.add('active');
    };

    window.closeExamModal = function () {
      document.getElementById('examModal').classList.remove('active');
    };

    window.editExam = function (id) {
      const exam = exams.find(e => (e.firebaseId || e.id) == id);
      if (!exam) return;

      currentEditingExam = exam;
      document.getElementById('examModalTitle').textContent = 'Deneme DÃ¼zenle';
      document.getElementById('examId').value = id;
      document.getElementById('examDate').value = exam.date;
      document.getElementById('examName').value = exam.name;
      document.getElementById('examNotes').value = exam.notes || '';

      if (exam.details) {
        document.getElementById('turkceD').value = exam.details.turkce.dogru;
        document.getElementById('turkceY').value = exam.details.turkce.yanlis;
        document.getElementById('matematikD').value = exam.details.matematik.dogru;
        document.getElementById('matematikY').value = exam.details.matematik.yanlis;

        ['tarih', 'cografya', 'felsefe', 'din'].forEach(sub => {
          document.getElementById(sub + 'D').value = exam.details.sosyal[sub].dogru;
          document.getElementById(sub + 'Y').value = exam.details.sosyal[sub].yanlis;
        });

        ['fizik', 'kimya', 'biyoloji'].forEach(sub => {
          document.getElementById(sub + 'D').value = exam.details.fen[sub].dogru;
          document.getElementById(sub + 'Y').value = exam.details.fen[sub].yanlis;
        });

        updateNets();
      }

      document.getElementById('examModal').classList.add('active');
    };

    window.deleteExam = async function (id) {
      if (!confirm('Bu denemeyi silmek istediÄŸinizden emin misiniz?')) return;

      try {
        if (useFirebase) {
          await deleteDoc(doc(db, 'exams', id));
        }
        exams = exams.filter(e => (e.firebaseId || e.id) != id);
        localStorage.setItem('yks-exams', JSON.stringify(exams));
        renderExams();
        updateStats();
      } catch (error) {
        alert('Silme hatasÄ±: ' + error.message);
      }
    };

    // Test modal functions
    window.openTestModal = function () {
      currentEditingTest = null;
      document.getElementById('testModalTitle').textContent = 'Yeni Test';
      document.getElementById('testForm').reset();
      document.getElementById('testDate').valueAsDate = new Date();
      document.getElementById('testId').value = '';
      document.getElementById('testModal').classList.add('active');
    };

    window.closeTestModal = function () {
      document.getElementById('testModal').classList.remove('active');
    };

    window.editTest = function (id) {
      const test = tests.find(t => (t.firebaseId || t.id) == id);
      if (!test) return;

      currentEditingTest = test;
      document.getElementById('testModalTitle').textContent = 'Test DÃ¼zenle';
      document.getElementById('testId').value = id;
      document.getElementById('testDate').value = test.date;
      document.getElementById('testSubject').value = test.subject;
      document.getElementById('testName').value = test.name;
      document.getElementById('testCorrect').value = test.correct;
      document.getElementById('testWrong').value = test.wrong;
      document.getElementById('testNotes').value = test.notes || '';
      document.getElementById('testModal').classList.add('active');
    };

    window.deleteTest = async function (id) {
      if (!confirm('Bu testi silmek istediÄŸinizden emin misiniz?')) return;

      try {
        if (useFirebase) {
          await deleteDoc(doc(db, 'tests', id));
        }
        tests = tests.filter(t => (t.firebaseId || t.id) != id);
        localStorage.setItem('yks-tests', JSON.stringify(tests));
        renderTests();
      } catch (error) {
        alert('Silme hatasÄ±: ' + error.message);
      }
    };

    // Form submissions
    document.getElementById('examForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const btn = document.getElementById('examSubmitBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="loading"></div> Kaydediliyor...';

      const sosyalD = parseInt(document.getElementById('sosyalD').textContent);
      const sosyalY = parseInt(document.getElementById('sosyalY').textContent);
      const fenD = parseInt(document.getElementById('fenD').textContent);
      const fenY = parseInt(document.getElementById('fenY').textContent);

      const examData = {
        id: currentEditingExam ? currentEditingExam.id : Date.now(),
        date: document.getElementById('examDate').value,
        name: document.getElementById('examName').value,
        notes: document.getElementById('examNotes').value,
        nets: {
          turkce: parseFloat(document.getElementById('turkceNet').textContent),
          sosyal: parseFloat(calculateNet(sosyalD, sosyalY)),
          matematik: parseFloat(document.getElementById('matematikNet').textContent),
          fen: parseFloat(calculateNet(fenD, fenY))
        },
        details: {
          turkce: {
            dogru: parseInt(document.getElementById('turkceD').value) || 0,
            yanlis: parseInt(document.getElementById('turkceY').value) || 0
          },
          matematik: {
            dogru: parseInt(document.getElementById('matematikD').value) || 0,
            yanlis: parseInt(document.getElementById('matematikY').value) || 0
          },
          sosyal: {
            dogru: sosyalD,
            yanlis: sosyalY,
            tarih: {
              dogru: parseInt(document.getElementById('tarihD').value) || 0,
              yanlis: parseInt(document.getElementById('tarihY').value) || 0
            },
            cografya: {
              dogru: parseInt(document.getElementById('cografyaD').value) || 0,
              yanlis: parseInt(document.getElementById('cografyaY').value) || 0
            },
            felsefe: {
              dogru: parseInt(document.getElementById('felsefeD').value) || 0,
              yanlis: parseInt(document.getElementById('felsefeY').value) || 0
            },
            din: {
              dogru: parseInt(document.getElementById('dinD').value) || 0,
              yanlis: parseInt(document.getElementById('dinY').value) || 0
            }
          },
          fen: {
            dogru: fenD,
            yanlis: fenY,
            fizik: {
              dogru: parseInt(document.getElementById('fizikD').value) || 0,
              yanlis: parseInt(document.getElementById('fizikY').value) || 0
            },
            kimya: {
              dogru: parseInt(document.getElementById('kimyaD').value) || 0,
              yanlis: parseInt(document.getElementById('kimyaY').value) || 0
            },
            biyoloji: {
              dogru: parseInt(document.getElementById('biyolojiD').value) || 0,
              yanlis: parseInt(document.getElementById('biyolojiY').value) || 0
            }
          }
        }
      };

      examData.totalNet = (examData.nets.turkce + examData.nets.sosyal + examData.nets.matematik + examData.nets.fen).toFixed(2);

      try {
        if (currentEditingExam) {
          if (useFirebase && currentEditingExam.firebaseId) {
            await updateDoc(doc(db, 'exams', currentEditingExam.firebaseId), examData);
          }
          const index = exams.findIndex(e => (e.firebaseId || e.id) == (currentEditingExam.firebaseId || currentEditingExam.id));
          exams[index] = { ...examData, firebaseId: currentEditingExam.firebaseId };
        } else {
          if (useFirebase) {
            const docRef = await addDoc(collection(db, 'exams'), examData);
            examData.firebaseId = docRef.id;
          }
          exams.push(examData);
        }

        exams.sort((a, b) => new Date(b.date) - new Date(a.date));
        localStorage.setItem('yks-exams', JSON.stringify(exams));
        renderExams();
        updateStats();
        closeExamModal();
      } catch (error) {
        alert('Hata: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Kaydet';
      }
    });

    document.getElementById('testForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const btn = document.getElementById('testSubmitBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="loading"></div> Kaydediliyor...';

      const testData = {
        id: currentEditingTest ? currentEditingTest.id : Date.now(),
        date: document.getElementById('testDate').value,
        subject: document.getElementById('testSubject').value,
        name: document.getElementById('testName').value,
        correct: parseInt(document.getElementById('testCorrect').value) || 0,
        wrong: parseInt(document.getElementById('testWrong').value) || 0,
        notes: document.getElementById('testNotes').value
      };

      try {
        if (currentEditingTest) {
          if (useFirebase && currentEditingTest.firebaseId) {
            await updateDoc(doc(db, 'tests', currentEditingTest.firebaseId), testData);
          }
          const index = tests.findIndex(t => (t.firebaseId || t.id) == (currentEditingTest.firebaseId || currentEditingTest.id));
          tests[index] = { ...testData, firebaseId: currentEditingTest.firebaseId };
        } else {
          if (useFirebase) {
            const docRef = await addDoc(collection(db, 'tests'), testData);
            testData.firebaseId = docRef.id;
          }
          tests.push(testData);
        }

        tests.sort((a, b) => new Date(b.date) - new Date(a.date));
        localStorage.setItem('yks-tests', JSON.stringify(tests));
        renderTests();
        closeTestModal();
      } catch (error) {
        alert('Hata: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Kaydet';
      }
    });

    // Charts
    let netChart, correctWrongChart;

    function createCharts() {
      if (exams.length === 0) return;

      const dates = exams.slice().reverse().map(e => new Date(e.date).toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' }));

      const netCtx = document.getElementById('netChart').getContext('2d');
      if (netChart) netChart.destroy();

      netChart = new Chart(netCtx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [
            {
              label: 'TÃ¼rkÃ§e',
              data: exams.slice().reverse().map(e => e.nets.turkce),
              borderColor: 'rgb(239, 68, 68)',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              tension: 0.4
            },
            {
              label: 'Sosyal',
              data: exams.slice().reverse().map(e => e.nets.sosyal),
              borderColor: 'rgb(234, 179, 8)',
              backgroundColor: 'rgba(234, 179, 8, 0.1)',
              tension: 0.4
            },
            {
              label: 'Matematik',
              data: exams.slice().reverse().map(e => e.nets.matematik),
              borderColor: 'rgb(59, 130, 246)',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4
            },
            {
              label: 'Fen',
              data: exams.slice().reverse().map(e => e.nets.fen),
              borderColor: 'rgb(34, 197, 94)',
              backgroundColor: 'rgba(34, 197, 94, 0.1)',
              tension: 0.4
            },
            {
              label: 'Toplam',
              data: exams.slice().reverse().map(e => parseFloat(e.totalNet)),
              borderColor: 'rgb(168, 85, 247)',
              backgroundColor: 'rgba(168, 85, 247, 0.1)',
              borderWidth: 3,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { position: 'top' }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      const cwCtx = document.getElementById('correctWrongChart').getContext('2d');
      if (correctWrongChart) correctWrongChart.destroy();

      const lastExam = exams[0];
      if (lastExam.details) {
        correctWrongChart = new Chart(cwCtx, {
          type: 'bar',
          data: {
            labels: ['TÃ¼rkÃ§e', 'Sosyal', 'Matematik', 'Fen'],
            datasets: [
              {
                label: 'DoÄŸru',
                data: [
                  lastExam.details.turkce.dogru,
                  lastExam.details.sosyal.dogru,
                  lastExam.details.matematik.dogru,
                  lastExam.details.fen.dogru
                ],
                backgroundColor: 'rgba(34, 197, 94, 0.7)'
              },
              {
                label: 'YanlÄ±ÅŸ',
                data: [
                  lastExam.details.turkce.yanlis,
                  lastExam.details.sosyal.yanlis,
                  lastExam.details.matematik.yanlis,
                  lastExam.details.fen.yanlis
                ],
                backgroundColor: 'rgba(239, 68, 68, 0.7)'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { position: 'top' },
              title: {
                display: true,
                text: 'Son Deneme - DoÄŸru/YanlÄ±ÅŸ DaÄŸÄ±lÄ±mÄ±'
              }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      }
    }

    loadExams();
    updateNets();

    // ğŸ“ YKS Countdown Logic
    // Hedef: 20 Haziran 2027 Saat 10:15 (Tahmini YKS 2027 Tarihi)
    // BugÃ¼n (3 Åubat 2026) itibariyle yaklaÅŸÄ±k 500+ gÃ¼n var.
    const YKS_DATE = new Date('2027-06-20T10:15:00').getTime();

    // Tarihi formatlayÄ±p ekrana yazalÄ±m
    const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
    document.getElementById('target-date-text').textContent = `Hedef: ${new Date(YKS_DATE).toLocaleDateString('tr-TR', dateOptions)}`;

    function updateCountdown() {
      const now = new Date().getTime();
      const distance = YKS_DATE - now;

      if (distance < 0) {
        document.getElementById('cd-days').textContent = "0";
        document.getElementById('cd-hours').textContent = "0";
        document.getElementById('cd-minutes').textContent = "0";
        document.getElementById('cd-seconds').textContent = "0";
        return;
      }

      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);

      document.getElementById('cd-days').textContent = days;
      document.getElementById('cd-hours').textContent = String(hours).padStart(2, '0');
      document.getElementById('cd-minutes').textContent = String(minutes).padStart(2, '0');
      document.getElementById('cd-seconds').textContent = String(seconds).padStart(2, '0');
    }

    // Her saniye gÃ¼ncelle
    setInterval(updateCountdown, 1000);
    // Ä°lk aÃ§Ä±lÄ±ÅŸta hemen Ã§alÄ±ÅŸtÄ±r
    updateCountdown();
  </script>
</body>

</html>
